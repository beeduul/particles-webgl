<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <title>WebGL Particles</title>
</head>
<body id="index">
  <canvas id="glcanvas" width="640" height="480">
    Your browser doesn't appear to support the <code>&lt;canvas&gt;</code> element.
  </canvas>
  
  <script id="particle_sim_vs" type="x-shader/x-vertex">
  #ifdef GL_ES
  precision highp float;
  #endif

  attribute vec3 aPosition;

  void main() {
    gl_Position = vec4(aPosition, 1.0);
  }
  </script>
  
  <script id="particle_sim_fs" type="x-shader/x-fragment">
  #extension GL_EXT_draw_buffers : require
  precision mediump float;
  
  uniform vec2 uResolution;
  uniform sampler2D uTexture0; // x, y, z, ttl
  uniform sampler2D uTexture1; // r, g, b, a

  void main() {
    vec2 uv = gl_FragCoord.xy / uResolution.xy;

    vec4 pdata_pos = texture2D(uTexture0, uv);
    vec4 pdata_color = texture2D(uTexture1, uv);
    vec3 pos = pdata_pos.xyz + vec3(0.001 * (pdata_pos.w - 5.0), 0.0, 0.0);
    float ttl = pdata_pos.w - 0.01;

    gl_FragData[0] = vec4(pos, ttl);
    gl_FragData[1] = pdata_color;
  }
  </script>
  
  <script id='particle_vs' type="x-shader/x-vertex">
  // attribute vec2 vertexPosition;
  attribute vec2 aUV;
  varying vec3 v3xyz;
  varying vec2 vUV;
  uniform sampler2D uTexture0; // x, y, z, t
  uniform sampler2D uTexture1; // r, g, b, a
  
  vec2 uvToScreen(vec2 uv) {
    return uv * 2.0 - vec2(1.0, 1.0);
  }
  
  void main() {
    vec4 pdata_pos = texture2D(uTexture0, aUV);
    v3xyz = pdata_pos.xyz;
    float ttl = pdata_pos.w;
    
    gl_PointSize = ttl * 5.0;
    gl_Position = vec4(v3xyz, 1.0);
    
    vUV = aUV;
  }
  </script>
  
  <script id='particle_fs' type="x-shader/x-fragment">
  #ifdef GL_ES
  precision highp float;
  #endif

  varying vec3 v3xyz;
  varying vec2 vUV;
  
  uniform sampler2D uTexture0; // x, y, z, t
  uniform sampler2D uTexture1; // r, g, b, a

  void main() {
    vec4 pdata_pos = texture2D(uTexture0, vUV);
    vec4 pdata_color = texture2D(uTexture1, vUV);
    
    float t = pdata_pos.w;
    if (t <= 0.0) {
      discard;
    }
    gl_FragColor = vec4(pdata_color.rgb, t / 10.0);
  }
  </script>
  
  <script src="app.js"></script>
  <script>require('app').init();</script>
  
</body>
</html>